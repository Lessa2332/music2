<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –ú—É–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è –¥–ª—è –†–ê–°-–¥—ñ—Ç–µ–π</title>
    
    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ —Ñ—ñ–∫—Å–æ–≤–∞–Ω–∏–º–∏ –≤–µ—Ä—Å—ñ—è–º–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands@0.4.1646424915/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/15.0.1/Tone.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a237e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #1a237e;
            --secondary: #4a148c;
            --accent: #FF4081;
            --success: #4CAF50;
            --warning: #FFC107;
            --info: #2196F3;
        }
        
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* –ö–∞–º–µ—Ä–∞ —Ç–∞ 3D */
        .camera-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #cameraView {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.2;
            transition: opacity 0.3s;
        }
        
        #canvas3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –û—Å–Ω–æ–≤–Ω—ñ UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ */
        .main-ui {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            pointer-events: none;
        }
        
        .main-ui > * {
            pointer-events: auto;
        }
        
        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */
        .title-bar {
            background: linear-gradient(135deg, var(--accent) 0%, #E91E63 100%);
            padding: 15px 25px;
            border-radius: 50px;
            border: 3px solid white;
            box-shadow: 0 8px 25px rgba(255, 64, 129, 0.4);
            backdrop-filter: blur(15px);
            margin-bottom: 15px;
            text-align: center;
            animation: pulse-glow 3s infinite alternate;
        }
        
        .title-bar h1 {
            font-size: 22px;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        /* –°—Ç–∞—Ç—É—Å –ø–∞–Ω–µ–ª—å */
        .status-panel {
            background: rgba(33, 150, 243, 0.95);
            padding: 15px 25px;
            border-radius: 30px;
            border: 3px solid white;
            backdrop-filter: blur(15px);
            margin-bottom: 15px;
            text-align: center;
            font-size: 18px;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .status-panel.success {
            background: rgba(76, 175, 80, 0.95);
            animation: success-pulse 2s infinite;
        }
        
        .status-panel.warning {
            background: rgba(255, 193, 7, 0.95);
            animation: warning-pulse 2s infinite;
        }
        
        /* –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ */
        .instruments-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .instrument-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border: 3px solid white;
            color: white;
            padding: 15px 8px;
            border-radius: 20px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        
        .instrument-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .instrument-btn:hover::before {
            left: 100%;
        }
        
        .instrument-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        
        .instrument-btn.active {
            background: linear-gradient(135deg, var(--success) 0%, #45a049 100%);
            transform: scale(1.05);
            box-shadow: 0 0 30px var(--success);
            border-color: #FFEB3B;
        }
        
        /* –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è */
        .settings-panel {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(15px);
            border: 3px solid var(--info);
            border-radius: 25px;
            padding: 20px;
            margin-bottom: 15px;
            display: none;
        }
        
        .settings-panel.active {
            display: block;
            animation: slide-up 0.3s ease-out;
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
        }
        
        .setting-item:last-child {
            margin-bottom: 0;
        }
        
        .slider {
            width: 60%;
            height: 20px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 10px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: white;
            border: 3px solid var(--accent);
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        /* –ö–µ—Ä—É–≤–∞–Ω–Ω—è */
        .controls-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .control-btn {
            background: linear-gradient(135deg, var(--info) 0%, #0d8bf2 100%);
            border: 3px solid white;
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            font-weight: bold;
            min-width: 140px;
            transition: all 0.3s;
            flex: 1;
            min-width: 0;
        }
        
        .control-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4);
        }
        
        .control-btn.secondary {
            background: linear-gradient(135deg, var(--warning) 0%, #ffb300 100%);
        }
        
        /* –í—ñ–∑—É–∞–ª—å–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ */
        .visual-indicators {
            position: fixed;
            pointer-events: none;
            z-index: 999;
        }
        
        .finger-display {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            opacity: 0.4;
            filter: drop-shadow(0 0 20px currentColor);
            transition: all 0.5s;
        }
        
        .progress-ring {
            position: fixed;
            bottom: 250px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 100px;
        }
        
        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.3s;
        }
        
        .finger-counter {
            position: fixed;
            bottom: 290px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 36px;
            color: var(--warning);
            text-shadow: 0 0 25px var(--warning);
            font-weight: bold;
        }
        
        /* –ö–æ–Ω—Ñ–µ—Ç—Ç—ñ –µ—Ñ–µ–∫—Ç */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1001;
            display: none;
        }
        
        .confetti.active {
            display: block;
            animation: confetti-fall 5s linear;
        }
        
        /* –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
        
        .progress-container {
            width: 80%;
            max-width: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 25px;
            padding: 20px;
            text-align: center;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            margin: 20px 0;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--accent));
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s;
        }
        
        /* –ê–Ω—ñ–º–∞—Ü—ñ—ó */
        @keyframes pulse-glow {
            0% { box-shadow: 0 8px 25px rgba(255, 64, 129, 0.4); }
            100% { box-shadow: 0 8px 40px rgba(255, 64, 129, 0.8); }
        }
        
        @keyframes success-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 40px rgba(76, 175, 80, 0.8); }
        }
        
        @keyframes warning-pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 193, 7, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 193, 7, 0.8); }
        }
        
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes confetti-fall {
            0% { opacity: 1; transform: translateY(-100%); }
            100% { opacity: 0; transform: translateY(100vh); }
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ñ—Å—Ç—å */
        @media (max-width: 768px) {
            .title-bar h1 { font-size: 18px; }
            .status-panel { font-size: 16px; padding: 12px 20px; }
            .instrument-btn { font-size: 14px; padding: 12px 6px; }
            .control-btn { font-size: 14px; padding: 10px 15px; }
            .finger-display { font-size: 60px; }
            .finger-counter { font-size: 28px; bottom: 270px; }
            .progress-ring { bottom: 230px; }
        }
        
        @media (max-height: 700px) {
            .instruments-grid { grid-template-columns: repeat(2, 1fr); }
            .finger-counter { bottom: 240px; }
            .progress-ring { bottom: 200px; }
        }
        
        /* –†–µ–∂–∏–º –¥–ª—è –†–ê–° */
        body.calm-mode {
            background: linear-gradient(135deg, #0d47a1 0%, #1a237e 100%);
        }
        
        body.calm-mode .title-bar {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        body.calm-mode .instrument-btn.active {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="progress-container">
            <div style="font-size: 60px; margin-bottom: 20px;">üéµ‚ú®</div>
            <h1 style="color: #FFEB3B; margin-bottom: 10px;">–ú—É–∑–∏—á–Ω–∞ —Ç–µ—Ä–∞–ø—ñ—è –¥–ª—è –†–ê–°</h1>
            <div id="loadingText">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="font-size: 14px; opacity: 0.8;">
                –î–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            </div>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ñ–µ—Ç—Ç—ñ –µ—Ñ–µ–∫—Ç -->
    <div class="confetti" id="confetti"></div>

    <!-- –û—Å–Ω–æ–≤–Ω—ñ UI –µ–ª–µ–º–µ–Ω—Ç–∏ -->
    <div class="main-ui">
        <div class="title-bar">
            <h1>üéµ –¢–ï–†–ê–ü–ï–í–¢–ò–ß–ù–ò–ô –ú–£–ó–ò–ß–ù–ò–ô –î–û–î–ê–¢–û–ö –î–õ–Ø –†–ê–°-–î–Ü–¢–ï–ô üéµ</h1>
        </div>
        
        <div class="status-panel" id="statusPanel">
            –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫" –¥–ª—è –ø–æ—á–∞—Ç–∫—É
        </div>

        <!-- –í—ñ–∑—É–∞–ª—å–Ω—ñ –ø–æ–∫–∞–∑–Ω–∏–∫–∏ -->
        <div class="visual-indicators finger-display" id="fingerDisplay">üëã</div>
        
        <svg class="visual-indicators progress-ring" id="progressRing" viewBox="0 0 100 100">
            <circle cx="50" cy="50" r="40" stroke="#FF4081" stroke-dasharray="251.2" 
                    stroke-dashoffset="251.2" id="progressCircle"></circle>
        </svg>
        
        <div class="visual-indicators finger-counter" id="fingerCounter">
            –ü–∞–ª—å—Ü—ñ–≤: <span id="fingerCount">0</span>/5
        </div>

        <!-- –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ -->
        <div class="instruments-grid" id="instrumentsGrid">
            <!-- –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ —á–µ—Ä–µ–∑ JS -->
        </div>

        <!-- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è -->
        <div class="settings-panel" id="settingsPanel">
            <div class="setting-item">
                <span>–ß—É—Ç–ª–∏–≤—ñ—Å—Ç—å –ø–∞–ª—å—Ü—ñ–≤:</span>
                <input type="range" min="1" max="10" value="5" class="slider" id="sensitivitySlider">
            </div>
            <div class="setting-item">
                <span>–ì—É—á–Ω—ñ—Å—Ç—å:</span>
                <input type="range" min="0" max="100" value="30" class="slider" id="volumeSlider">
            </div>
            <div class="setting-item">
                <span>–†–µ–∂–∏–º:</span>
                <select id="modeSelect" style="padding: 8px; border-radius: 10px; border: 2px solid white;">
                    <option value="normal">–ù–æ—Ä–º–∞–ª—å–Ω–∏–π</option>
                    <option value="calm">–°–ø–æ–∫—ñ–π–Ω–∏–π</option>
                    <option value="single">–ü–æ –æ–¥–Ω–æ–º—É –∑–≤—É–∫—É</option>
                </select>
            </div>
        </div>

        <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è -->
        <div class="controls-row">
            <button class="control-btn" onclick="startAudio()" id="audioBtn">üîä –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫</button>
            <button class="control-btn secondary" onclick="toggleSettings()">‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</button>
            <button class="control-btn" onclick="toggleCamera()" id="cameraBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
            <button class="control-btn secondary" onclick="startRecording()" id="recordBtn">‚è∫Ô∏è –ó–∞–ø–∏—Å (30—Å)</button>
            <button class="control-btn" onclick="showHelp()">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
        </div>
    </div>

    <!-- –ö–∞–º–µ—Ä–∞ —Ç–∞ 3D -->
    <div class="camera-container" id="cameraContainer">
        <video id="cameraView" autoplay playsinline muted></video>
    </div>
    <canvas id="canvas3d"></canvas>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registered');
                }).catch(error => {
                    console.log('ServiceWorker registration failed:', error);
                });
            });
        }
    </script>

    <script>
        // ========== –ö–û–ù–°–¢–ê–ù–¢–ò –¢–ê –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ==========
        const CONFIG = {
            VERSION: '1.0.0',
            MAX_POLYPHONY: 6,
            FINGER_THRESHOLD: 0.05,
            SENSITIVITY_VALUES: [0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.10, 0.12],
            MODES: {
                NORMAL: 'normal',
                CALM: 'calm',
                SINGLE: 'single'
            }
        };

        // ========== –°–ò–°–¢–ï–ú–ù–Ü –ó–ú–Ü–ù–ù–Ü ==========
        let scene, camera, renderer;
        let hands = null;
        let currentMode = CONFIG.MODES.NORMAL;
        let audioStarted = false;
        let settingsOpen = false;
        let isRecording = false;
        let recordStartTime = 0;
        let recordData = [];
        
        // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
        let settings = {
            sensitivity: 5, // 1-10
            volume: 30, // 0-100
            facingMode: 'user',
            savedInstrument: 'piano'
        };
        
        // –ê—É–¥—ñ–æ —Å–∏—Å—Ç–µ–º–∞
        let audioContext;
        let synthPool = [];
        let samplerPool = {};
        let activeNotes = new Set();
        
        // –¢—Ä–µ–∫—ñ–Ω–≥
        let activeFingers = [];
        let lastFingerCount = 0;
        let fingerObjects = [];
        
        // DOM –µ–ª–µ–º–µ–Ω—Ç–∏
        const elements = {
            loadingOverlay: document.getElementById('loadingOverlay'),
            loadingText: document.getElementById('loadingText'),
            progressFill: document.getElementById('progressFill'),
            statusPanel: document.getElementById('statusPanel'),
            fingerDisplay: document.getElementById('fingerDisplay'),
            fingerCount: document.getElementById('fingerCount'),
            fingerCounter: document.getElementById('fingerCounter'),
            progressCircle: document.getElementById('progressCircle'),
            progressRing: document.getElementById('progressRing'),
            confetti: document.getElementById('confetti'),
            cameraView: document.getElementById('cameraView'),
            cameraContainer: document.getElementById('cameraContainer'),
            canvas3d: document.getElementById('canvas3d'),
            instrumentsGrid: document.getElementById('instrumentsGrid'),
            settingsPanel: document.getElementById('settingsPanel'),
            sensitivitySlider: document.getElementById('sensitivitySlider'),
            volumeSlider: document.getElementById('volumeSlider'),
            modeSelect: document.getElementById('modeSelect'),
            audioBtn: document.getElementById('audioBtn'),
            cameraBtn: document.getElementById('cameraBtn'),
            recordBtn: document.getElementById('recordBtn')
        };

        // ========== –Ü–ù–°–¢–†–£–ú–ï–ù–¢–ò –ö–û–ù–§–Ü–ì ==========
        const INSTRUMENTS = [
            { id: 'piano', name: 'üéπ –ü—ñ–∞–Ω—ñ–Ω–æ', color: '#FF4081', type: 'sampler' },
            { id: 'bells', name: 'üîî –î–∑–≤—ñ–Ω–æ—á–∫–∏', color: '#4CAF50', type: 'sampler' },
            { id: 'nature', name: 'üåø –ü—Ä–∏—Ä–æ–¥–∞', color: '#2196F3', type: 'sampler' },
            { id: 'animals', name: 'üêæ –¢–≤–∞—Ä–∏–Ω–∏', color: '#FFC107', type: 'sampler' },
            { id: 'drums', name: 'ü•Å –ë–∞—Ä–∞–±–∞–Ω–∏', color: '#9C27B0', type: 'synth' },
            { id: 'synth', name: 'üéõÔ∏è –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä', color: '#00BCD4', type: 'synth' }
        ];

        // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ==========
        async function init() {
            updateProgress(10, "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É...");
            
            try {
                // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
                loadSettings();
                
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                initUI();
                
                updateProgress(30, "–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è 3D...");
                initThreeJS();
                
                updateProgress(50, "–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—É–¥—ñ–æ...");
                initAudio();
                
                updateProgress(70, "–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç—Ä–µ–∫—ñ–Ω–≥—É —Ä—É–∫...");
                await initHandTracking();
                
                updateProgress(90, "–û—Å—Ç–∞—Ç–æ—á–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è...");
                initEventListeners();
                
                updateProgress(100, "–ì–æ—Ç–æ–≤–æ!");
                
                // –°—Ö–æ–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
                setTimeout(() => {
                    elements.loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        elements.loadingOverlay.style.display = 'none';
                        updateStatus("–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å '–£–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫' –¥–ª—è –ø–æ—á–∞—Ç–∫—É", "warning");
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó:", error);
                updateStatus("–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –û–Ω–æ–≤—ñ—Ç—å —Å—Ç–æ—Ä—ñ–Ω–∫—É.", "warning");
            }
        }

        function updateProgress(percent, text) {
            elements.progressFill.style.width = percent + '%';
            elements.loadingText.textContent = text;
        }

        // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
        function initUI() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
            INSTRUMENTS.forEach(instrument => {
                const button = document.createElement('button');
                button.className = 'instrument-btn';
                button.innerHTML = instrument.name;
                button.dataset.id = instrument.id;
                button.dataset.color = instrument.color;
                
                if (instrument.id === settings.savedInstrument) {
                    button.classList.add('active');
                }
                
                button.onclick = () => switchInstrument(instrument.id);
                elements.instrumentsGrid.appendChild(button);
            });
            
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Å–ª–∞–π–¥–µ—Ä—ñ–≤
            elements.sensitivitySlider.value = settings.sensitivity;
            elements.volumeSlider.value = settings.volume;
            elements.modeSelect.value = currentMode;
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø—Ä–æ–≥—Ä–µ—Å—É
            updateProgressRing(0);
        }

        function updateStatus(message, type = 'normal') {
            elements.statusPanel.textContent = message;
            elements.statusPanel.className = 'status-panel';
            
            if (type === 'success') {
                elements.statusPanel.classList.add('success');
            } else if (type === 'warning') {
                elements.statusPanel.classList.add('warning');
            }
        }

        function updateFingerDisplay(count) {
            const displays = ["üëã", "üëÜ", "‚úåÔ∏è", "ü§ü", "üññ", "üñêÔ∏è"];
            const display = count > 5 ? "üñêÔ∏è" : displays[count];
            elements.fingerDisplay.textContent = display;
            
            // –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É
            const colors = ['#FF4081', '#FF9800', '#4CAF50', '#2196F3', '#9C27B0', '#FFEB3B'];
            elements.fingerDisplay.style.color = colors[Math.min(count, colors.length - 1)];
            elements.fingerDisplay.style.opacity = count > 0 ? '0.8' : '0.3';
            elements.fingerDisplay.style.fontSize = (60 + count * 8) + 'px';
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞
            elements.fingerCount.textContent = count;
            updateProgressRing((count / 5) * 100);
            
            // –ö–æ–Ω—Ñ–µ—Ç—Ç—ñ –ø—Ä–∏ 5 –ø–∞–ª—å—Ü—è—Ö
            if (count === 5 && lastFingerCount !== 5) {
                triggerConfetti();
                updateStatus("–ß—É–¥–æ–≤–æ! –í—Å—ñ –ø–∞–ª—å—á–∏–∫–∏! ‚ú®", "success");
            }
            
            lastFingerCount = count;
        }

        function updateProgressRing(percent) {
            const circumference = 251.2;
            const offset = circumference - (percent / 100) * circumference;
            elements.progressCircle.style.strokeDashoffset = offset;
            
            // –ó–º—ñ–Ω–∞ –∫–æ–ª—å–æ—Ä—É
            let color;
            if (percent < 20) color = '#FF4081';
            else if (percent < 40) color = '#FF9800';
            else if (percent < 60) color = '#FFC107';
            else if (percent < 80) color = '#4CAF50';
            else color = '#00E676';
            
            elements.progressCircle.style.stroke = color;
        }

        function triggerConfetti() {
            elements.confetti.classList.add('active');
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ñ–µ—Ç—Ç—ñ —á–∞—Å—Ç–∏–Ω–∫–∏
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '20px';
                confetti.style.height = '20px';
                confetti.style.background = ['#FF4081', '#4CAF50', '#2196F3', '#FFEB3B', '#9C27B0'][i % 5];
                confetti.style.borderRadius = '50%';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-20px';
                confetti.style.animation = `confetti-fall ${1 + Math.random() * 2}s linear forwards`;
                confetti.style.animationDelay = Math.random() * 2 + 's';
                elements.confetti.appendChild(confetti);
                
                setTimeout(() => confetti.remove(), 7000);
            }
            
            setTimeout(() => {
                elements.confetti.classList.remove('active');
                elements.confetti.innerHTML = '';
            }, 5000);
        }

        // ========== THREE.JS ==========
        function initThreeJS() {
            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            scene.fog = new THREE.Fog(0x1a237e, 1, 15);
            
            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 5;
            
            // –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ 
                canvas: elements.canvas3d, 
                alpha: true, 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            
            // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 15);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            scene.add(directionalLight);
            
            // –§–æ–Ω–æ–≤—ñ —á–∞—Å—Ç–∏–Ω–∫–∏
            createBackgroundParticles();
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è
            function animate() {
                requestAnimationFrame(animate);
                
                // –ê–Ω—ñ–º–∞—Ü—ñ—è —Ñ–æ–Ω–æ–≤–∏—Ö —á–∞—Å—Ç–∏–Ω–æ–∫
                if (window.particles) {
                    window.particles.rotation.y += 0.001;
                    window.particles.rotation.x += 0.0005;
                }
                
                renderer.render(scene, camera);
            }
            animate();
        }

        function createBackgroundParticles() {
            const particleCount = 300;
            const positions = new Float32Array(particleCount * 3);
            const colors = new Float32Array(particleCount * 3);
            
            for (let i = 0; i < particleCount * 3; i += 3) {
                positions[i] = (Math.random() - 0.5) * 30;
                positions[i + 1] = (Math.random() - 0.5) * 30;
                positions[i + 2] = (Math.random() - 1) * 30;
                
                colors[i] = Math.random() * 0.5 + 0.5;
                colors[i + 1] = Math.random() * 0.5 + 0.5;
                colors[i + 2] = Math.random() * 0.5 + 0.5;
            }
            
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            
            const material = new THREE.PointsMaterial({
                size: 0.1,
                vertexColors: true,
                transparent: true,
                opacity: 0.6,
                sizeAttenuation: true
            });
            
            window.particles = new THREE.Points(geometry, material);
            scene.add(window.particles);
        }

        function createFingerEffect(x, y, z, color, index) {
            // –°—Ñ–µ—Ä–∞ –¥–ª—è –ø–∞–ª—å—Ü—è
            const geometry = new THREE.SphereGeometry(0.15, 24, 24);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                emissive: color,
                emissiveIntensity: 0.3,
                shininess: 100,
                transparent: true,
                opacity: 0.9
            });
            
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(x, y, z);
            sphere.castShadow = true;
            scene.add(sphere);
            fingerObjects.push(sphere);
            
            // –°–≤—ñ—Ç–ª–æ –¥–ª—è –ø–∞–ª—å—Ü—è
            const light = new THREE.PointLight(color, 1, 3);
            light.position.set(x, y, z);
            scene.add(light);
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è
            const startTime = Date.now();
            const scale = 0.5 + index * 0.1;
            
            function animate() {
                const elapsed = Date.now() - startTime;
                
                if (elapsed > 1500) {
                    scene.remove(sphere);
                    scene.remove(light);
                    const sphereIndex = fingerObjects.indexOf(sphere);
                    if (sphereIndex > -1) fingerObjects.splice(sphereIndex, 1);
                    return;
                }
                
                // –ü—É–ª—å—Å–∞—Ü—ñ—è
                const pulse = 1 + Math.sin(elapsed * 0.01) * 0.2;
                sphere.scale.setScalar(scale * pulse);
                
                // –û–±–µ—Ä—Ç–∞–Ω–Ω—è
                sphere.rotation.y = elapsed * 0.002;
                sphere.rotation.x = elapsed * 0.001;
                
                // –ó–Ω–∏–∫–Ω–µ–Ω–Ω—è
                sphere.material.opacity = 0.9 - (elapsed / 1500) * 0.9;
                light.intensity = 1 - (elapsed / 1500);
                
                requestAnimationFrame(animate);
            }
            
            animate();
        }

        // ========== –ê–£–î–Ü–û –°–ò–°–¢–ï–ú–ê ==========
        async function initAudio() {
            // –ß–µ–∫–∞—î–º–æ –Ω–∞ user gesture –¥–ª—è –∑–∞–ø—É—Å–∫—É
            elements.audioBtn.onclick = startAudio;
        }

        async function startAudio() {
            if (audioStarted) return;
            
            try {
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Tone.js
                await Tone.start();
                audioStarted = true;
                
                // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
                Tone.Destination.volume.value = Tone.gainToDb(settings.volume / 100);
                
                // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø—É–ª—ñ–≤ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä—ñ–≤
                createSynthPool();
                
                // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ–º–ø–ª–µ—Ä—ñ–≤
                await loadSamplers();
                
                elements.audioBtn.textContent = "üîä –ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ";
                elements.audioBtn.disabled = true;
                updateStatus("–ó–≤—É–∫ –≥–æ—Ç–æ–≤–∏–π! –ü–æ–∫–∞–∂–∏ –ø–∞–ª—å—á–∏–∫–∏ –∫–∞–º–µ—Ä—ñ üñêÔ∏è", "success");
                
                // –¢–µ—Å—Ç–æ–≤–∏–π –∑–≤—É–∫
                playTestSound();
                
            } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –∞—É–¥—ñ–æ:", error);
                updateStatus("–ù–µ –≤–¥–∞–ª–æ—Å—è —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫", "warning");
            }
        }

        function createSynthPool() {
            // –ü—É–ª –∑ 6 —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä—ñ–≤ (–∑–∞ CONFIG.MAX_POLYPHONY)
            for (let i = 0; i < CONFIG.MAX_POLYPHONY; i++) {
                const synth = new Tone.Synth({
                    oscillator: { type: "sine" },
                    envelope: {
                        attack: 0.01,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 0.5
                    }
                }).connect(Tone.Destination);
                
                synthPool.push({
                    synth: synth,
                    available: true,
                    note: null
                });
            }
        }

        async function loadSamplers() {
            // –°–µ–º–ø–ª–µ—Ä–∏ –¥–ª—è —Ä—ñ–∑–Ω–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
            const samplerConfigs = {
                piano: {
                    baseUrl: 'https://tonejs.github.io/audio/salamander/',
                    urls: {
                        'C3': 'C3.mp3',
                        'D3': 'D3.mp3',
                        'E3': 'E3.mp3',
                        'F3': 'F3.mp3',
                        'G3': 'G3.mp3'
                    }
                },
                bells: {
                    baseUrl: 'https://tonejs.github.io/audio/casio/',
                    urls: {
                        'C5': 'C5.mp3',
                        'E5': 'E5.mp3',
                        'G5': 'G5.mp3'
                    }
                }
            };
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ —Å–µ–º–ø–ª–µ—Ä–∏
            for (const [id, config] of Object.entries(samplerConfigs)) {
                samplerPool[id] = new Tone.Sampler(config.urls, {
                    baseUrl: config.baseUrl,
                    onload: () => {
                        console.log(`${id} sampler loaded`);
                        samplerPool[id].connect(Tone.Destination);
                    }
                });
            }
            
            // –î–ª—è —ñ–Ω—à–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∏
            samplerPool.nature = new Tone.FMSynth({
                harmonicity: 3,
                modulationIndex: 10,
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.5,
                    decay: 0.5,
                    sustain: 0.3,
                    release: 2
                }
            }).connect(Tone.Destination);
            
            samplerPool.animals = new Tone.MembraneSynth().connect(Tone.Destination);
            samplerPool.drums = new Tone.NoiseSynth({
                noise: { type: "white" },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0
                }
            }).connect(Tone.Destination);
            
            samplerPool.synth = new Tone.AMSynth().connect(Tone.Destination);
        }

        function playSound(note, instrumentId, duration = '8n') {
            if (!audioStarted) return;
            
            const now = Tone.now();
            const durationMs = Tone.Time(duration).toMilliseconds();
            
            // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è —Ä–µ–∂–∏–º—É "–ü–æ –æ–¥–Ω–æ–º—É –∑–≤—É–∫—É"
            if (currentMode === CONFIG.MODES.SINGLE && activeNotes.size >= 1) {
                return;
            }
            
            // –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è —Å–ø–æ–∫—ñ–π–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É
            if (currentMode === CONFIG.MODES.CALM && activeNotes.size >= 2) {
                return;
            }
            
            // –ì—Ä–∞–º–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å–µ–º–ø–ª–µ—Ä–∞ –∞–±–æ —Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä–∞
            if (samplerPool[instrumentId]) {
                if (instrumentId === 'piano' || instrumentId === 'bells') {
                    samplerPool[instrumentId].triggerAttackRelease(note, duration, now);
                } else {
                    // –î–ª—è —ñ–Ω—à–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤
                    const pitches = ['C3', 'D3', 'E3', 'F3', 'G3'];
                    const pitch = pitches[Math.floor(Math.random() * pitches.length)];
                    samplerPool[instrumentId].triggerAttackRelease(pitch, duration, now);
                }
            }
            
            activeNotes.add(note);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è
            setTimeout(() => {
                activeNotes.delete(note);
            }, durationMs + 100);
        }

        function playTestSound() {
            if (!audioStarted) return;
            
            setTimeout(() => {
                playSound('C4', settings.savedInstrument, '8n');
            }, 300);
        }

        // ========== –¢–†–ï–ö–Ü–ù–ì –†–£–ö ==========
        async function initHandTracking() {
            try {
                hands = new Hands({
                    locateFile: (file) => {
                        // –°–ø—Ä–æ–±–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è WASM
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                    }
                });
                
                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 0,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5,
                    selfieMode: true
                });
                
                hands.onResults(onHandResults);
                
                // –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏
                await startCamera();
                
            } catch (error) {
                console.warn("–ü–æ–º–∏–ª–∫–∞ —Ç—Ä–µ–∫—ñ–Ω–≥—É:", error);
                enableTouchMode();
            }
        }

        async function startCamera() {
            try {
                const constraints = {
                    video: { 
                        facingMode: settings.facingMode,
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        frameRate: { ideal: 30 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.cameraView.srcObject = stream;
                
                // –û–±—Ä–æ–±–∫–∞ –∫–∞–¥—Ä—ñ–≤
                async function processFrame() {
                    if (elements.cameraView.readyState >= 2) {
                        try {
                            await hands.send({ image: elements.cameraView });
                        } catch (e) {
                            console.warn("–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ –∫–∞–¥—Ä—É:", e);
                        }
                    }
                    requestAnimationFrame(processFrame);
                }
                
                elements.cameraView.onloadeddata = processFrame;
                updateStatus("–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞! –ü–æ–∫–∞–∂–∏ –ø–∞–ª—å—á–∏–∫–∏ üëÜ", "success");
                
            } catch (error) {
                console.warn("–ü–æ–º–∏–ª–∫–∞ –∫–∞–º–µ—Ä–∏:", error);
                updateStatus("–ö–∞–º–µ—Ä–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç–æ—Ä–∫–∞–Ω–Ω—è", "warning");
                enableTouchMode();
            }
        }

        function onHandResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                updateFingerDisplay(0);
                return;
            }
            
            const landmarks = results.multiHandLandmarks[0];
            const raisedFingers = detectRaisedFingers(landmarks);
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            updateFingerDisplay(raisedFingers.length);
            
            // –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—ñ–≤
            if (audioStarted && raisedFingers.length > 0) {
                playFingerSounds(raisedFingers);
            }
            
            // –í—ñ–∑—É–∞–ª—å–Ω—ñ –µ—Ñ–µ–∫—Ç–∏
            createHandEffects(landmarks, raisedFingers);
            
            // –ó–∞–ø–∏—Å —Å–µ—Å—ñ—ó
            if (isRecording) {
                recordSessionData(raisedFingers);
            }
        }

        function detectRaisedFingers(landmarks) {
            const raised = [];
            const threshold = CONFIG.SENSITIVITY_VALUES[settings.sensitivity - 1];
            
            const fingerTips = [4, 8, 12, 16, 20];
            const fingerBases = [2, 5, 9, 13, 17];
            
            fingerTips.forEach((tipIndex, fingerIndex) => {
                const tip = landmarks[tipIndex];
                const base = landmarks[fingerBases[fingerIndex]];
                
                if (tip.y < base.y - threshold) {
                    raised.push({
                        index: fingerIndex,
                        name: ['–í–µ–ª–∏–∫–∏–π', '–í–∫–∞–∑—ñ–≤–Ω–∏–π', '–°–µ—Ä–µ–¥–Ω—ñ–π', '–ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π', '–ú—ñ–∑–∏–Ω–µ—Ü—å'][fingerIndex],
                        position: tip
                    });
                }
            });
            
            return raised;
        }

        function playFingerSounds(fingers) {
            const notes = ['C3', 'D3', 'E3', 'F3', 'G3'];
            
            fingers.forEach((finger, index) => {
                // –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∫—Ä–∞—â–æ–≥–æ –∑–≤—É—á–∞–Ω–Ω—è
                setTimeout(() => {
                    const note = notes[finger.index % notes.length];
                    playSound(note, settings.savedInstrument, currentMode === CONFIG.MODES.CALM ? '4n' : '8n');
                }, index * 50);
            });
        }

        function createHandEffects(landmarks, fingers) {
            // –û—á–∏—â–µ–Ω–Ω—è —Å—Ç–∞—Ä–∏—Ö –æ–±'—î–∫—Ç—ñ–≤
            fingerObjects.forEach(obj => scene.remove(obj));
            fingerObjects = [];
            
            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –µ—Ñ–µ–∫—Ç—ñ–≤
            fingers.forEach((finger, index) => {
                const x = (finger.position.x * 2 - 1) * 5;
                const y = -(finger.position.y * 2 - 1) * 3;
                const z = -2;
                
                // –ö–æ–ª—ñ—Ä –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                const instrument = INSTRUMENTS.find(i => i.id === settings.savedInstrument);
                const color = new THREE.Color(instrument ? instrument.color : '#FF4081');
                
                createFingerEffect(x, y, z, color, index);
            });
        }

        // ========== –¢–û–†–ö–ê–ù–ù–Ø ==========
        function enableTouchMode() {
            document.addEventListener('touchstart', handleTouch);
            document.addEventListener('mousedown', handleTouch);
            updateStatus("–¢–æ—Ä–∫–∞–π—Ç–µ—Å—è –µ–∫—Ä–∞–Ω—É –ø–∞–ª—å—Ü—è–º–∏ üëá", "warning");
        }

        function handleTouch(event) {
            event.preventDefault();
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –∑–∞–ø—É—Å–∫ –∞—É–¥—ñ–æ
            if (!audioStarted) {
                startAudio();
                return;
            }
            
            const x = event.clientX || (event.touches && event.touches[0].clientX);
            const y = event.clientY || (event.touches && event.touches[0].clientY);
            
            if (!x || !y) return;
            
            // –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –ø–∞–ª—å—Ü—è
            const sectionWidth = window.innerWidth / 5;
            const fingerIndex = Math.min(4, Math.floor(x / sectionWidth));
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
            updateFingerDisplay(1);
            
            // –í—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–≤—É–∫—É
            const notes = ['C3', 'D3', 'E3', 'F3', 'G3'];
            const note = notes[fingerIndex % notes.length];
            playSound(note, settings.savedInstrument);
            
            // –í—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç
            const xPos = (x / window.innerWidth) * 10 - 5;
            const yPos = -(y / window.innerHeight) * 6 + 3;
            const instrument = INSTRUMENTS.find(i => i.id === settings.savedInstrument);
            const color = new THREE.Color(instrument ? instrument.color : '#FF4081');
            
            createFingerEffect(xPos, yPos, -2, color, fingerIndex);
        }

        // ========== –ù–ê–õ–ê–®–¢–£–í–ê–ù–ù–Ø ==========
        function toggleSettings() {
            settingsOpen = !settingsOpen;
            elements.settingsPanel.classList.toggle('active');
        }

        function saveSettings() {
            settings.sensitivity = parseInt(elements.sensitivitySlider.value);
            settings.volume = parseInt(elements.volumeSlider.value);
            currentMode = elements.modeSelect.value;
            
            // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≥—É—á–Ω–æ—Å—Ç—ñ
            if (audioStarted) {
                Tone.Destination.volume.value = Tone.gainToDb(settings.volume / 100);
            }
            
            // –ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è —Ä–µ–∂–∏–º—É
            document.body.classList.toggle('calm-mode', currentMode === CONFIG.MODES.CALM);
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage
            localStorage.setItem('ras-therapy-settings', JSON.stringify(settings));
            localStorage.setItem('ras-therapy-mode', currentMode);
            
            updateStatus("–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–±–µ—Ä–µ–∂–µ–Ω–æ", "success");
        }

        function loadSettings() {
            const savedSettings = localStorage.getItem('ras-therapy-settings');
            const savedMode = localStorage.getItem('ras-therapy-mode');
            const savedInstrument = localStorage.getItem('ras-therapy-instrument');
            
            if (savedSettings) {
                Object.assign(settings, JSON.parse(savedSettings));
            }
            
            if (savedMode) {
                currentMode = savedMode;
            }
            
            if (savedInstrument) {
                settings.savedInstrument = savedInstrument;
            }
        }

        // ========== –ö–ï–†–£–í–ê–ù–ù–Ø ==========
        function switchInstrument(instrumentId) {
            settings.savedInstrument = instrumentId;
            
            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.id === instrumentId) {
                    btn.classList.add('active');
                }
            });
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è
            localStorage.setItem('ras-therapy-instrument', instrumentId);
            
            // –¢–µ—Å—Ç–æ–≤–∏–π –∑–≤—É–∫
            if (audioStarted) {
                playTestSound();
            }
            
            updateStatus(`–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${INSTRUMENTS.find(i => i.id === instrumentId).name}`);
        }

        function toggleCamera() {
            settings.facingMode = settings.facingMode === 'user' ? 'environment' : 'user';
            elements.cameraBtn.textContent = settings.facingMode === 'user' ? 'üì∑ –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞' : 'üì∑ –ó–∞–¥–Ω—è';
            
            // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏
            if (elements.cameraView.srcObject) {
                elements.cameraView.srcObject.getTracks().forEach(track => track.stop());
                startCamera();
            }
        }

        function startRecording() {
            if (isRecording) {
                stopRecording();
                return;
            }
            
            isRecording = true;
            recordStartTime = Date.now();
            recordData = [];
            elements.recordBtn.textContent = '‚èπÔ∏è –ó—É–ø–∏–Ω–∏—Ç–∏ –∑–∞–ø–∏—Å';
            elements.recordBtn.classList.add('secondary');
            
            updateStatus("–ó–∞–ø–∏—Å —Å–µ—Å—ñ—ó (30 —Å–µ–∫—É–Ω–¥)...", "warning");
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∑—É–ø–∏–Ω–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                }
            }, 30000);
        }

        function stopRecording() {
            isRecording = false;
            elements.recordBtn.textContent = '‚è∫Ô∏è –ó–∞–ø–∏—Å (30—Å)';
            elements.recordBtn.classList.remove('secondary');
            
            // –ê–Ω–∞–ª—ñ–∑ –¥–∞–Ω–∏—Ö
            const duration = (Date.now() - recordStartTime) / 1000;
            const totalFingers = recordData.reduce((sum, data) => sum + data.fingerCount, 0);
            const avgFingers = totalFingers / recordData.length || 0;
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É
            const sessionResult = {
                date: new Date().toISOString(),
                duration: duration,
                avgFingers: avgFingers.toFixed(1),
                maxFingers: Math.max(...recordData.map(d => d.fingerCount))
            };
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –≤ localStorage
            let sessions = JSON.parse(localStorage.getItem('ras-therapy-sessions') || '[]');
            sessions.push(sessionResult);
            localStorage.setItem('ras-therapy-sessions', JSON.stringify(sessions));
            
            updateStatus(`–°–µ—Å—ñ—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–µ—Ä–µ–¥–Ω—å–æ: ${avgFingers.toFixed(1)} –ø–∞–ª—å—Ü—ñ–≤`, "success");
            
            // –ü–æ–∫–∞–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
            setTimeout(() => {
                alert(
                    `üìä –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Å–µ—Å—ñ—ó:\n\n` +
                    `–ß–∞—Å: ${duration.toFixed(0)} —Å–µ–∫—É–Ω–¥\n` +
                    `–°–µ—Ä–µ–¥–Ω—è –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–∞–ª—å—Ü—ñ–≤: ${avgFingers.toFixed(1)}\n` +
                    `–ú–∞–∫—Å–∏–º—É–º –ø–∞–ª—å—Ü—ñ–≤: ${sessionResult.maxFingers}\n\n` +
                    `–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–±–µ—Ä–µ–∂–µ–Ω–æ!`
                );
            }, 500);
        }

        function recordSessionData(fingers) {
            recordData.push({
                timestamp: Date.now(),
                fingerCount: fingers.length
            });
        }

        function showHelp() {
            alert(
                "üéµ –ú–£–ó–ò–ß–ù–ê –¢–ï–†–ê–ü–Ü–Ø –î–õ–Ø –†–ê–°-–î–Ü–¢–ï–ô\n\n" +
                "üéØ –ú–ï–¢–ê: –†–æ–∑–≤–∏—Ç–æ–∫ –¥—Ä—ñ–±–Ω–æ—ó –º–æ—Ç–æ—Ä–∏–∫–∏, —Å–µ–Ω—Å–æ—Ä–Ω–æ—ó —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—ó —Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—ó\n\n" +
                "üëÜ –Ø–ö –í–ò–ö–û–†–ò–°–¢–û–í–£–í–ê–¢–ò:\n" +
                "1. –£–≤—ñ–º–∫–Ω—ñ—Ç—å –∑–≤—É–∫ (–æ–¥–Ω–æ–≥–æ —Ä–∞–∑—É)\n" +
                "2. –ü–æ–∫–∞–∂—ñ—Ç—å –ø–∞–ª—å—á–∏–∫–∏ –∫–∞–º–µ—Ä—ñ\n" +
                "3. –ö–æ–∂–µ–Ω –ø–∞–ª–µ—Ü—å ‚Äî —Å–≤—ñ–π –∑–≤—É–∫\n" +
                "4. –°–ø—Ä–æ–±—É–π—Ç–µ —Ä—ñ–∑–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏\n" +
                "5. –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ —Ç–æ—Ä–∫–∞–Ω–Ω—è, —è–∫—â–æ –∫–∞–º–µ—Ä–∞ –Ω–µ –ø—Ä–∞—Ü—é—î\n\n" +
                "‚öôÔ∏è –†–ï–ñ–ò–ú–ò:\n" +
                "‚Ä¢ –ù–æ—Ä–º–∞–ª—å–Ω–∏–π ‚Äî –≤—Å—ñ —Ñ—É–Ω–∫—Ü—ñ—ó\n" +
                "‚Ä¢ –°–ø–æ–∫—ñ–π–Ω–∏–π ‚Äî —Ç–∏—Ö—ñ –∑–≤—É–∫–∏, —Å–ø–æ–≤—ñ–ª—å–Ω–µ–Ω—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó\n" +
                "‚Ä¢ –ü–æ –æ–¥–Ω–æ–º—É ‚Äî –ª–∏—à–µ –æ–¥–∏–Ω –∑–≤—É–∫ –æ–¥–Ω–æ—á–∞—Å–Ω–æ\n\n" +
                "üìä –§–£–ù–ö–¶–Ü–á:\n" +
                "‚Ä¢ –ó–∞–ø–∏—Å —Å–µ—Å—ñ—ó (30 —Å–µ–∫) ‚Äî –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É\n" +
                "‚Ä¢ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —á—É—Ç–ª–∏–≤–æ—Å—Ç—ñ\n" +
                "‚Ä¢ –ü–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –∫–∞–º–µ—Ä–∏\n" +
                "‚Ä¢ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ–±—Ä–∞–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É\n\n" +
                "üåü –¢–ï–†–ê–ü–ï–í–¢–ò–ß–ù–Ü –ï–§–ï–ö–¢–ò:\n" +
                "‚Ä¢ –†–æ–∑–≤–∏—Ç–æ–∫ —ñ–∑–æ–ª—è—Ü—ñ—ó –ø–∞–ª—å—Ü—ñ–≤\n" \\
                "‚Ä¢ –ü–æ–ª—ñ–ø—à–µ–Ω–Ω—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—ó —Ä—É–∫–∞-–æ–∫–æ\n" \\
                "‚Ä¢ –°–µ–Ω—Å–æ—Ä–Ω–∞ —Å—Ç–∏–º—É–ª—è—Ü—ñ—è (–∑—ñ—Ä, —Å–ª—É—Ö, –ø—Ä–æ–ø—Ä—ñ–æ—Ü–µ–ø—Ü—ñ—è)\n" \\
                "‚Ä¢ –ü–æ–∑–∏—Ç–∏–≤–Ω–µ –ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ –º—É–∑–∏–∫—É\n\n" +
                "–î–æ–¥–∞—Ç–æ–∫ –ø—Ä–∞—Ü—é—î –æ—Ñ–ª–∞–π–Ω –ø—ñ—Å–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è!"
            );
        }

        // ========== EVENT LISTENERS ==========
        function initEventListeners() {
            // –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
            elements.sensitivitySlider.addEventListener('input', saveSettings);
            elements.volumeSlider.addEventListener('input', saveSettings);
            elements.modeSelect.addEventListener('change', saveSettings);
            
            // –†–µ—Å–∞–π–∑ –≤—ñ–∫–Ω–∞
            window.addEventListener('resize', () => {
                if (camera && renderer) {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                }
            });
            
            // PWA: –î–æ–¥–∞—Ç–∏ –Ω–∞ –¥–æ–º–∞—à–Ω—ñ–π –µ–∫—Ä–∞–Ω
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                updateStatus("üí° –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –Ω–∞ –¥–æ–º–∞—à–Ω—ñ–π –µ–∫—Ä–∞–Ω!", "success");
            });
        }

        // ========== –ó–ê–ü–£–°–ö ==========
        window.addEventListener('load', init);
    </script>
</body>
</html>
