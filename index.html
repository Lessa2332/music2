<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ –¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏–π –æ—Ä–∫–µ—Å—Ç—Ä –¥–ª—è –†–ê–°</title>
    
    <!-- –ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a237e 0%, #4a148c 100%);
            color: white;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: none;
        }
        
        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }
        
        #cameraView {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
            opacity: 0.3;
        }
        
        #canvas3d {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .header {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            z-index: 1000;
            text-align: center;
        }
        
        .title {
            background: rgba(255, 64, 129, 0.9);
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 24px;
            border: 3px solid white;
            box-shadow: 0 5px 20px rgba(255, 64, 129, 0.5);
            backdrop-filter: blur(10px);
            margin-bottom: 10px;
        }
        
        .status {
            background: rgba(33, 150, 243, 0.9);
            padding: 12px 20px;
            border-radius: 30px;
            border: 3px solid white;
            backdrop-filter: blur(10px);
            font-size: 18px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .instruments {
            position: fixed;
            bottom: 120px;
            left: 20px;
            right: 20px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            z-index: 1000;
        }
        
        .instrument-btn {
            background: rgba(255, 193, 7, 0.9);
            border: 3px solid white;
            color: #1a237e;
            padding: 12px 8px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            text-align: center;
            transition: all 0.3s;
        }
        
        .instrument-btn.active {
            background: #4CAF50;
            color: white;
            transform: scale(1.05);
        }
        
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
            z-index: 1000;
        }
        
        .control-btn {
            background: rgba(76, 175, 80, 0.9);
            border: 2px solid white;
            color: white;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            min-width: 100px;
        }
        
        .finger-display {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 60px;
            z-index: 3;
            opacity: 0.5;
            pointer-events: none;
        }
        
        .counter {
            position: fixed;
            bottom: 200px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 30px;
            color: #FFEB3B;
            z-index: 1000;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a237e;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .title { font-size: 18px; padding: 12px 20px; }
            .status { font-size: 16px; padding: 10px 15px; }
            .instrument-btn { font-size: 12px; padding: 10px 5px; }
            .control-btn { font-size: 12px; padding: 8px 12px; min-width: 80px; }
            .counter { font-size: 24px; bottom: 180px; }
            .finger-display { font-size: 50px; }
        }
    </style>
</head>
<body>
    <!-- –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è -->
    <div class="loading" id="loading">
        <div>
            <div style="font-size: 60px;">üéµ</div>
            <h1 style="color: #FFEB3B; margin: 20px 0;">–¢–µ—Ä–∞–ø–µ–≤—Ç–∏—á–Ω–∏–π –æ—Ä–∫–µ—Å—Ç—Ä</h1>
            <div>–ì–æ—Ç—É—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏...</div>
        </div>
    </div>

    <!-- –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
    <div class="header">
        <div class="title">üéµ –†–û–ó–í–ò–¢–û–ö –ú–û–¢–û–†–ò–ö–ò –ß–ï–†–ï–ó –ú–£–ó–ò–ö–£ üéµ</div>
        <div class="status" id="status">–¢–æ—Ä–∫–Ω—ñ—Ç—å—Å—è –µ–∫—Ä–∞–Ω—É –¥–ª—è –ø–æ—á–∞—Ç–∫—É</div>
    </div>
    
    <div class="finger-display" id="fingerDisplay">üëã</div>
    
    <div class="counter" id="counter">
        –ü–∞–ª—å—Ü—ñ–≤: <span id="fingerCount">0</span>
    </div>

    <div class="instruments">
        <button class="instrument-btn active" onclick="switchInstrument('piano')">üéπ –ù–æ—Ç–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('drums')">ü•Å –ë–∞—Ä–∞–±–∞–Ω–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('bells')">üîî –î–∑–≤—ñ–Ω–æ—á–∫–∏</button>
        <button class="instrument-btn" onclick="switchInstrument('synth')">üéõÔ∏è –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä</button>
        <button class="instrument-btn" onclick="switchInstrument('nature')">üåø –ü—Ä–∏—Ä–æ–¥–∞</button>
        <button class="instrument-btn" onclick="switchInstrument('animals')">üêæ –ó–≤—ñ—Ä—ñ</button>
    </div>

    <div class="controls">
        <button class="control-btn" onclick="startAudio()">üîä –£–≤—ñ–º–∫. –∑–≤—É–∫</button>
        <button class="control-btn" onclick="showHelp()">‚ùì –î–æ–ø–æ–º–æ–≥–∞</button>
        <button class="control-btn" onclick="toggleDebug()">üêõ –ù–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è</button>
    </div>

    <!-- –í—ñ–¥–µ–æ —Ç–∞ 3D -->
    <div class="video-container">
        <video id="cameraView" autoplay playsinline muted></video>
    </div>
    <canvas id="canvas3d"></canvas>

    <script>
        // ========== –ö–û–ù–°–¢–ê–ù–¢–ò ==========
        const CONFIG = {
            VOLUME: 0.3,
            NOTES: ['C3', 'D3', 'E3', 'F3', 'G3', 'A3', 'B3', 'C4'],
            FINGER_NAMES: ['–í–µ–ª–∏–∫–∏–π', '–í–∫–∞–∑—ñ–≤–Ω–∏–π', '–°–µ—Ä–µ–¥–Ω—ñ–π', '–ë–µ–∑—ñ–º–µ–Ω–Ω–∏–π', '–ú—ñ–∑–∏–Ω–µ—Ü—å'],
            COLORS: [0xFF4081, 0x4CAF50, 0x2196F3, 0xFFEB3B, 0x9C27B0]
        };

        // ========== –ó–ú–Ü–ù–ù–Ü ==========
        let scene, camera, renderer;
        let hands = null;
        let currentInstrument = 'piano';
        let audioStarted = false;
        let synth, drums, bells, natureSynth, animalSynth;
        let activeFingers = [];
        let fingerObjects = [];
        let debugMode = false;

        // –ï–ª–µ–º–µ–Ω—Ç–∏ DOM
        const elements = {
            loading: document.getElementById('loading'),
            status: document.getElementById('status'),
            fingerDisplay: document.getElementById('fingerDisplay'),
            fingerCount: document.getElementById('fingerCount'),
            counter: document.getElementById('counter'),
            cameraView: document.getElementById('cameraView'),
            canvas3d: document.getElementById('canvas3d')
        };

        // ========== –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø ==========
        async function init() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Three.js
            initThreeJS();
            
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∞—É–¥—ñ–æ (—á–µ–∫–∞—î–º–æ –∫–ª—ñ–∫—É)
            initAudio();
            
            // –ù–∞–º–∞–≥–∞—î–º–æ—Å—è —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Ç—Ä–µ–∫—ñ–Ω–≥ —Ä—É–∫
            try {
                await initHandTracking();
            } catch (error) {
                console.log("–¢—Ä–µ–∫—ñ–Ω–≥ –Ω–µ –ø—Ä–∞—Ü—é—î, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–æ—Ä–∫–∞–Ω–Ω—è");
                initTouchControls();
            }
            
            // –°—Ö–æ–≤–∞—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
            setTimeout(() => {
                elements.loading.style.opacity = '0';
                setTimeout(() => {
                    elements.loading.style.display = 'none';
                    updateStatus("–ü–æ–∫–∞–∂–∏ –ø–∞–ª—å—á–∏–∫–∏ –∫–∞–º–µ—Ä—ñ –∞–±–æ —Ç–æ—Ä–∫–Ω–∏—Å—è –µ–∫—Ä–∞–Ω—É");
                }, 500);
            }, 1000);
        }

        // ========== THREE.JS ==========
        function initThreeJS() {
            // –°—Ü–µ–Ω–∞
            scene = new THREE.Scene();
            
            // –ö–∞–º–µ—Ä–∞
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.z = 5;
            
            // –†–µ–Ω–¥–µ—Ä–µ—Ä
            renderer = new THREE.WebGLRenderer({ 
                canvas: elements.canvas3d, 
                alpha: true, 
                antialias: true 
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            
            // –û—Å–≤—ñ—Ç–ª–µ–Ω–Ω—è
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 7);
            scene.add(directionalLight);
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
        }

        // ========== –ê–£–î–Ü–û ==========
        function initAudio() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, –∞–ª–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞—î–º–æ
            createAudioInstruments();
        }

        function createAudioInstruments() {
            // –ó–∞–≥–∞–ª—å–Ω–∏–π –≤–∏—Ö—ñ–¥
            const output = new Tone.Gain(CONFIG.VOLUME).toDestination();
            
            // –§–æ—Ä—Ç–µ–ø—ñ–∞–Ω–æ
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.5
                }
            }).connect(output);
            
            // –ë–∞—Ä–∞–±–∞–Ω–∏
            drums = new Tone.NoiseSynth({
                noise: { type: "white" },
                envelope: {
                    attack: 0.001,
                    decay: 0.1,
                    sustain: 0
                }
            }).connect(output);
            
            // –î–∑–≤—ñ–Ω–æ—á–∫–∏
            bells = new Tone.PolySynth(Tone.FMSynth, {
                harmonicity: 8,
                modulationIndex: 2,
                oscillator: { type: "sine" }
            }).connect(output);
            
            // –ü—Ä–∏—Ä–æ–¥–∞
            natureSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.5,
                    decay: 0.5,
                    sustain: 0.3,
                    release: 2
                }
            }).connect(output);
            
            // –¢–≤–∞—Ä–∏–Ω–∏
            animalSynth = new Tone.MembraneSynth().connect(output);
        }

        function startAudio() {
            if (audioStarted) return;
            
            Tone.start().then(() => {
                audioStarted = true;
                updateStatus("–ó–≤—É–∫ —É–≤—ñ–º–∫–Ω–µ–Ω–æ! –ü–æ–∫–∞–∂–∏ –ø–∞–ª—å—á–∏–∫–∏ –∫–∞–º–µ—Ä—ñ");
                elements.status.style.background = "rgba(76, 175, 80, 0.9)";
            }).catch(error => {
                updateStatus("–ù–µ –≤–¥–∞–ª–æ—Å—è —É–≤—ñ–º–∫–Ω—É—Ç–∏ –∑–≤—É–∫");
                console.error("Audio error:", error);
            });
        }

        // ========== –¢–†–ï–ö–Ü–ù–ì –†–£–ö ==========
        async function initHandTracking() {
            return new Promise((resolve, reject) => {
                try {
                    hands = new Hands({
                        locateFile: (file) => {
                            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                        }
                    });
                    
                    hands.setOptions({
                        maxNumHands: 1,
                        modelComplexity: 0,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    
                    hands.onResults(onHandResults);
                    
                    // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–∞–º–µ—Ä—É
                    startCamera().then(resolve).catch(reject);
                    
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: "user",
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                });
                
                elements.cameraView.srcObject = stream;
                
                // –û–±—Ä–æ–±–∫–∞ –∫–∞–¥—Ä—ñ–≤
                async function processFrame() {
                    if (elements.cameraView.readyState >= 2) {
                        try {
                            await hands.send({ image: elements.cameraView });
                        } catch (e) {
                            console.warn("Frame processing error:", e);
                        }
                    }
                    requestAnimationFrame(processFrame);
                }
                
                elements.cameraView.onloadeddata = processFrame;
                
            } catch (error) {
                console.warn("Camera error:", error);
                throw error;
            }
        }

        function onHandResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                // –†—É–∫–∏ –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ
                elements.fingerDisplay.textContent = "üëã";
                updateFingerCount(0);
                return;
            }
            
            const landmarks = results.multiHandLandmarks[0];
            const raisedFingers = detectRaisedFingers(landmarks);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateFingerDisplay(raisedFingers.length);
            updateFingerCount(raisedFingers.length);
            
            // –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –∑–≤—É–∫–∏
            if (audioStarted && raisedFingers.length > 0) {
                playSounds(raisedFingers);
            }
            
            // –í—ñ–∑—É–∞–ª—å–Ω—ñ –µ—Ñ–µ–∫—Ç–∏
            createFingerEffects(landmarks, raisedFingers);
            
            if (debugMode) {
                showDebugInfo(raisedFingers);
            }
        }

        function detectRaisedFingers(landmarks) {
            const raised = [];
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—ñ–¥–Ω—è—Ç—ñ –ø–∞–ª—å—Ü—ñ
            const fingerTips = [4, 8, 12, 16, 20];
            const fingerBases = [2, 5, 9, 13, 17];
            
            fingerTips.forEach((tipIndex, fingerIndex) => {
                const tip = landmarks[tipIndex];
                const base = landmarks[fingerBases[fingerIndex]];
                
                // –Ø–∫—â–æ –∫—ñ–Ω—á–∏–∫ –≤–∏—â–µ –æ—Å–Ω–æ–≤–∏ –Ω–∞ –ø–µ–≤–Ω—É –≤–µ–ª–∏—á–∏–Ω—É
                if (tip.y < base.y - 0.05) {
                    raised.push({
                        index: fingerIndex,
                        name: CONFIG.FINGER_NAMES[fingerIndex],
                        position: tip
                    });
                }
            });
            
            return raised;
        }

        // ========== –¢–û–†–ö–ê–ù–ù–Ø –ï–ö–†–ê–ù–£ ==========
        function initTouchControls() {
            updateStatus("–¢–æ—Ä–∫–∞–π—Ç–µ—Å—è –µ–∫—Ä–∞–Ω—É –ø–∞–ª—å—Ü—è–º–∏");
            
            document.addEventListener('touchstart', handleTouch);
            document.addEventListener('mousedown', handleTouch);
        }

        function handleTouch(event) {
            event.preventDefault();
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –∞—É–¥—ñ–æ –ø—Ä–∏ –ø–µ—Ä—à–æ–º—É —Ç–æ—Ä–∫–∞–Ω–Ω—ñ
            if (!audioStarted) {
                startAudio();
            }
            
            const x = event.clientX || (event.touches && event.touches[0].clientX);
            const y = event.clientY || (event.touches && event.touches[0].clientY);
            
            if (!x || !y) return;
            
            // –í–∏–∑–Ω–∞—á–∞—î–º–æ "–ø–∞–ª–µ—Ü—å" –∑–∞ –ø–æ–∑–∏—Ü—ñ—î—é
            const sectionWidth = window.innerWidth / 5;
            const fingerIndex = Math.min(4, Math.floor(x / sectionWidth));
            
            // –Ü–º—ñ—Ç—É—î–º–æ –ø—ñ–¥–Ω—è—Ç–∏–π –ø–∞–ª–µ—Ü—å
            const fakeFinger = {
                index: fingerIndex,
                name: CONFIG.FINGER_NAMES[fingerIndex],
                position: { x: x / window.innerWidth, y: y / window.innerHeight }
            };
            
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateFingerDisplay(1);
            updateFingerCount(1);
            
            // –í—ñ–¥—Ç–≤–æ—Ä—é—î–º–æ –∑–≤—É–∫
            if (audioStarted) {
                playSoundForFinger(fakeFinger);
            }
            
            // –í—ñ–∑—É–∞–ª—å–Ω–∏–π –µ—Ñ–µ–∫—Ç
            createTouchEffect(x, y, fingerIndex);
        }

        // ========== –ó–í–£–ö–ò ==========
        function playSounds(fingers) {
            fingers.forEach((finger, index) => {
                setTimeout(() => {
                    playSoundForFinger(finger);
                }, index * 50);
            });
        }

        function playSoundForFinger(finger) {
            if (!audioStarted) return;
            
            const now = Tone.now();
            const noteIndex = finger.index % CONFIG.NOTES.length;
            const note = CONFIG.NOTES[noteIndex];
            
            switch(currentInstrument) {
                case 'piano':
                    synth.triggerAttackRelease(note, '8n', now);
                    break;
                    
                case 'drums':
                    playDrumSound(finger.index, now);
                    break;
                    
                case 'bells':
                    bells.triggerAttackRelease(note, '4n', now);
                    break;
                    
                case 'synth':
                    playSynthSound(finger.index, now);
                    break;
                    
                case 'nature':
                    natureSynth.triggerAttackRelease(note, '2n', now);
                    break;
                    
                case 'animals':
                    playAnimalSound(finger.index, now);
                    break;
            }
        }

        function playDrumSound(fingerIndex, time) {
            const drumTypes = [
                { pitch: 'C2', duration: '8n' },
                { pitch: 'D2', duration: '16n' },
                { pitch: 'E2', duration: '32n' },
                { pitch: 'F2', duration: '8n' },
                { pitch: 'G2', duration: '16n' }
            ];
            
            const drum = drumTypes[fingerIndex % drumTypes.length];
            drums.triggerAttackRelease(drum.duration, time);
        }

        function playSynthSound(fingerIndex, time) {
            const notes = ['C4', 'E4', 'G4', 'B4', 'D5'];
            const note = notes[fingerIndex % notes.length];
            
            const fmSynth = new Tone.FMSynth({
                harmonicity: 3 + fingerIndex,
                modulationIndex: 10
            }).toDestination();
            
            fmSynth.triggerAttackRelease(note, '8n', time);
        }

        function playAnimalSound(fingerIndex, time) {
            const sounds = [
                { pitch: 'C2', duration: '4n' },
                { pitch: 'D2', duration: '8n' },
                { pitch: 'E2', duration: '16n' },
                { pitch: 'F2', duration: '4n' },
                { pitch: 'G2', duration: '8n' }
            ];
            
            const sound = sounds[fingerIndex % sounds.length];
            animalSynth.triggerAttackRelease(sound.pitch, sound.duration, time);
        }

        // ========== –í–Ü–ó–£–ê–õ–¨–ù–Ü –ï–§–ï–ö–¢–ò ==========
        function createFingerEffects(landmarks, fingers) {
            // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –æ–±'—î–∫—Ç–∏
            fingerObjects.forEach(obj => scene.remove(obj));
            fingerObjects = [];
            
            // –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤—ñ –æ–±'—î–∫—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –ø–∞–ª—å—Ü—è
            fingers.forEach(finger => {
                const x = (finger.position.x * 2 - 1) * 5;
                const y = -(finger.position.y * 2 - 1) * 3;
                const color = CONFIG.COLORS[finger.index % CONFIG.COLORS.length];
                
                createFingerSphere(x, y, color);
            });
        }

        function createFingerSphere(x, y, color) {
            const geometry = new THREE.SphereGeometry(0.1, 16, 16);
            const material = new THREE.MeshBasicMaterial({ 
                color: color,
                transparent: true,
                opacity: 0.8
            });
            
            const sphere = new THREE.Mesh(geometry, material);
            sphere.position.set(x, y, -2);
            scene.add(sphere);
            fingerObjects.push(sphere);
            
            // –ê–Ω—ñ–º–∞—Ü—ñ—è
            const startTime = Date.now();
            
            function animateSphere() {
                const elapsed = Date.now() - startTime;
                if (elapsed > 1000) {
                    scene.remove(sphere);
                    const index = fingerObjects.indexOf(sphere);
                    if (index > -1) fingerObjects.splice(index, 1);
                    return;
                }
                
                const scale = 1 + Math.sin(elapsed / 100) * 0.3;
                sphere.scale.setScalar(scale);
                sphere.material.opacity = 0.8 - (elapsed / 1000) * 0.8;
                
                requestAnimationFrame(animateSphere);
            }
            
            animateSphere();
        }

        function createTouchEffect(x, y, fingerIndex) {
            const xPos = (x / window.innerWidth) * 10 - 5;
            const yPos = -(y / window.innerHeight) * 6 + 3;
            const color = CONFIG.COLORS[fingerIndex % CONFIG.COLORS.length];
            
            createFingerSphere(xPos, yPos, color);
        }

        // ========== –Ü–ù–¢–ï–†–§–ï–ô–° ==========
        function updateStatus(message) {
            elements.status.textContent = message;
        }

        function updateFingerDisplay(count) {
            const displays = ["üëã", "üëÜ", "‚úåÔ∏è", "ü§ü", "üññ", "üñêÔ∏è"];
            const index = Math.min(count, displays.length - 1);
            elements.fingerDisplay.textContent = displays[index];
            elements.fingerDisplay.style.opacity = count > 0 ? "0.8" : "0.3";
        }

        function updateFingerCount(count) {
            elements.fingerCount.textContent = count;
            
            // –ó–º—ñ–Ω—é—î–º–æ –∫–æ–ª—ñ—Ä
            if (count === 0) {
                elements.counter.style.color = '#FF4081';
            } else if (count <= 2) {
                elements.counter.style.color = '#4CAF50';
            } else if (count <= 4) {
                elements.counter.style.color = '#2196F3';
            } else {
                elements.counter.style.color = '#FFEB3B';
            }
        }

        function switchInstrument(instrument) {
            currentInstrument = instrument;
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            // –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞–∑–≤—É —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            const names = {
                'piano': '–ù–æ—Ç–∏',
                'drums': '–ë–∞—Ä–∞–±–∞–Ω–∏', 
                'bells': '–î–∑–≤—ñ–Ω–æ—á–∫–∏',
                'synth': '–°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä',
                'nature': '–ü—Ä–∏—Ä–æ–¥–∞',
                'animals': '–ó–≤—ñ—Ä—ñ'
            };
            
            updateStatus(`–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: ${names[instrument]}`);
            
            // –¢–µ—Å—Ç–æ–≤–∏–π –∑–≤—É–∫
            if (audioStarted) {
                setTimeout(() => {
                    playTestSound();
                }, 100);
            }
        }

        function playTestSound() {
            const now = Tone.now();
            
            switch(currentInstrument) {
                case 'piano':
                    synth.triggerAttackRelease('C4', '8n', now);
                    break;
                case 'drums':
                    drums.triggerAttackRelease('8n', now);
                    break;
                case 'bells':
                    bells.triggerAttackRelease('C5', '4n', now);
                    break;
            }
        }

        function showHelp() {
            alert(
                "üéµ –¢–ï–†–ê–ü–ï–í–¢–ò–ß–ù–ò–ô –û–†–ö–ï–°–¢–† –î–õ–Ø –†–û–ó–í–ò–¢–ö–£ –ú–û–¢–û–†–ò–ö–ò\n\n" +
                "üéØ –ú–ï–¢–ê: –†–æ–∑–≤–∏—Ç–æ–∫ –¥—Ä—ñ–±–Ω–æ—ó –º–æ—Ç–æ—Ä–∏–∫–∏ —Ç–∞ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—ó\n\n" +
                "üëÜ –Ø–ö –ì–†–ê–¢–ò:\n" +
                "1. –ü–æ–∫–∞–∂—ñ—Ç—å –ø–∞–ª—å—á–∏–∫–∏ –∫–∞–º–µ—Ä—ñ\n" +
                "2. –ö–æ–∂–µ–Ω –ø–∞–ª–µ—Ü—å - —Å–≤—ñ–π –∑–≤—É–∫\n" +
                "3. –¢–æ—Ä–∫–∞–π—Ç–µ—Å—è –µ–∫—Ä–∞–Ω—É, —è–∫—â–æ –∫–∞–º–µ—Ä–∞ –Ω–µ –ø—Ä–∞—Ü—é—î\n" +
                "4. –°–ø—Ä–æ–±—É–π—Ç–µ —Ä—ñ–∑–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏\n\n" +
                "üéπ –Ü–ù–°–¢–†–£–ú–ï–ù–¢–ò:\n" +
                "‚Ä¢ –ù–æ—Ç–∏ - –º—É–∑–∏—á–Ω—ñ –∑–≤—É–∫–∏\n" +
                "‚Ä¢ –ë–∞—Ä–∞–±–∞–Ω–∏ - —Ä–∏—Ç–º—ñ—á–Ω—ñ –∑–≤—É–∫–∏\n" +
                "‚Ä¢ –î–∑–≤—ñ–Ω–æ—á–∫–∏ - –º–µ–ª–æ–¥—ñ–π–Ω—ñ –∑–≤—É–∫–∏\n" +
                "‚Ä¢ –°–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä - –µ–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ñ –∑–≤—É–∫–∏\n" +
                "‚Ä¢ –ü—Ä–∏—Ä–æ–¥–∞ - —Å–ø–æ–∫—ñ–π–Ω—ñ –∑–≤—É–∫–∏\n" +
                "‚Ä¢ –ó–≤—ñ—Ä—ñ - –∑–≤—É–∫–∏ —Ç–≤–∞—Ä–∏–Ω\n\n" +
                "üåü –î–õ–Ø –†–ê–°-–î–Ü–¢–ï–ô:\n" +
                "‚Ä¢ –†–æ–∑–≤–∏–≤–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—é —Ä—É–∫\n" +
                "‚Ä¢ –°—Ç–∏–º—É–ª—é—î —Å–µ–Ω—Å–æ—Ä–Ω—É —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é\n" +
                "‚Ä¢ –ü—ñ–¥–≤–∏—â—É—î –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü—ñ—é —É–≤–∞–≥–∏\n" +
                "‚Ä¢ –°—Ç–≤–æ—Ä—é—î –ø–æ–∑–∏—Ç–∏–≤–Ω—ñ –∞—Å–æ—Ü—ñ–∞—Ü—ñ—ó"
            );
        }

        function toggleDebug() {
            debugMode = !debugMode;
            updateStatus(debugMode ? "–†–µ–∂–∏–º –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è —É–≤—ñ–º–∫–Ω–µ–Ω–æ" : "–†–µ–∂–∏–º –Ω–∞–ª–∞–≥–æ–¥–∂–µ–Ω–Ω—è –≤–∏–º–∫–Ω–µ–Ω–æ");
        }

        function showDebugInfo(fingers) {
            console.log(`–ü–∞–ª—å—Ü—ñ–≤: ${fingers.length}`);
            fingers.forEach(f => {
                console.log(`${f.name}: x=${f.position.x.toFixed(2)}, y=${f.position.y.toFixed(2)}`);
            });
        }

        // ========== –ó–ê–ü–£–°–ö ==========
        window.addEventListener('load', init);
        
        window.addEventListener('resize', () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        window.switchInstrument = switchInstrument;
        window.startAudio = startAudio;
        window.showHelp = showHelp;
        window.toggleDebug = toggleDebug;
    </script>
</body>
</html>
